<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京东物流 V1.0 法定预测报告</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial;
      margin:18px;background:#f6f7f9;color:#111
    }
    .wrap{max-width:1480px;margin:0 auto}
    .card{background:#fff;border:1px solid #e6e8eb;border-radius:12px;padding:18px;margin:14px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    h1{font-size:22px;margin:0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{background:#f1f3f5;border:1px solid #e6e8eb;border-radius:10px;padding:6px 10px;font-size:13px;color:#333}
    .btn{cursor:pointer;border:1px solid #e6e8eb;background:#fff;border-radius:10px;padding:8px 12px;font-size:13px}
    .meta{font-size:13px;color:#555;line-height:1.7;margin-top:10px}
    .hint{font-size:12px;color:#666;margin-top:8px}
    .err{color:#b42318}
    .sec-title{font-size:15px;font-weight:700;margin:0 0 10px 0}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #e6e8eb;padding:8px 10px;vertical-align:top}
    th{background:#f7f8fa;text-align:left;white-space:nowrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:#666}
    .ok{color:#1a7f37;font-weight:600}
    .bad{color:#b42318;font-weight:600}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr}
    }
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px}
    .kv .k{color:#666}
    .kv .v{color:#111}
    .hr{height:1px;background:#e6e8eb;margin:12px 0}
    .note{font-size:12px;color:#666;line-height:1.6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>京东物流 V1.0 法定预测报告</h1>
        <div class="row">
          <button class="btn" onclick="loadReport()">刷新数据</button>
          <span class="badge" id="status">状态：加载中…</span>
        </div>
      </div>

      <div id="meta" class="meta">正在加载 latest_report.json ...</div>
      <div class="hint">说明：本页每次打开都会自动拉取最新 latest_report.json（已禁用缓存），保证“打开即最新”。</div>
    </div>

    <div class="card">
      <div class="sec-title">① 当日实际交易数据</div>
      <div id="m1"></div>
      <div class="note" id="m1_note"></div>
    </div>

    <div class="card">
      <div class="sec-title">② 昨日预测回顾</div>
      <div id="m2"></div>
    </div>

    <div class="card">
      <div class="sec-title">③ 次日价格分布预测（T+1）</div>
      <div id="m3"></div>
      <div class="note">说明：分位点 p 表示“价格不超过该值的概率”。例如 p=0.50 为中位数（P50）。</div>
    </div>

    <div class="card">
      <div class="sec-title">④ 未来1个月价格分布预测</div>
      <div id="m4"></div>
      <div class="note">说明：分位点为模型在未来 1 个月期末价格的概率分布估计。</div>
    </div>

    <div class="card">
      <div class="sec-title">⑤ 未来6个月价格分布预测</div>
      <div id="m5"></div>
      <div class="note">说明：分位点为模型在未来 6 个月期末价格的概率分布估计。</div>
    </div>

    <div class="card">
      <div class="sec-title">⑥ 模型状态与学习更新</div>
      <div id="m6"></div>
      <div class="note">说明：此板块用于披露模型版本、参数与学习状态（不包含任何交易建议）。</div>
    </div>

    <div class="card">
      <div class="sec-title">⑦ 过去五个交易日预测命中回顾</div>
      <div id="m7"></div>
    </div>

  </div>

<script>
function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function fmtNum(x, digits=3){
  if(x===null || x===undefined || x==='' || Number.isNaN(Number(x))) return '—';
  const n = Number(x);
  return n.toFixed(digits);
}
function fmtInt(x){
  if(x===null || x===undefined || x==='' || Number.isNaN(Number(x))) return '—';
  return String(Math.round(Number(x)));
}
function fmtMoney(x, digits=2){
  if(x===null || x===undefined || x==='' || Number.isNaN(Number(x))) return '—';
  return Number(x).toFixed(digits);
}
function pct(x, digits=2){
  if(x===null || x===undefined || x==='' || Number.isNaN(Number(x))) return '—';
  return (Number(x)*100).toFixed(digits) + '%';
}

function tableKV(rows){
  let html = '<table><tbody>';
  for(const [k,v] of rows){
    html += `<tr><th>${esc(k)}</th><td>${v}</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

function tableDist(arr){
  const rows = Array.isArray(arr) ? arr : [];
  let html = '<table><thead><tr><th>分位点 p</th><th>价格 v（HKD）</th></tr></thead><tbody>';
  for(const it of rows){
    const p = it?.p;
    const v = it?.v;
    html += `<tr><td class="mono">${esc(p)}</td><td class="mono">${esc(fmtNum(v,3))}</td></tr>`;
  }
  if(rows.length===0){
    html += `<tr><td colspan="2" class="muted">暂无数据</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

function tableLast5(arr){
  const rows = Array.isArray(arr) ? arr : [];
  let html = '<table><thead><tr>' +
    '<th>预测日期</th><th>预测中位价（P50）</th><th>实际收盘价</th><th>误差</th><th>命中分位区间</th><th>判断结果</th><th>生成时间（BJT）</th>' +
    '</tr></thead><tbody>';

  for(const it of rows){
    const predDate = it?.y_pred_trade_date ?? '—';
    const p50 = it?.y_pred_p50;
    const close = it?.today_close;
    const err = it?.error;
    const band = it?.hit_band ?? '—';
    const judge = it?.judgment ?? '—';
    const ts = it?.generated_at_bjt ?? '—';

    const judgeClass = String(judge).includes('命中') ? 'ok' : 'bad';

    html += `<tr>
      <td>${esc(predDate)}</td>
      <td class="mono">${esc(fmtNum(p50,3))}</td>
      <td class="mono">${esc(fmtNum(close,3))}</td>
      <td class="mono">${esc(fmtNum(err,3))}</td>
      <td>${esc(band)}</td>
      <td class="${judgeClass}">${esc(judge)}</td>
      <td class="mono">${esc(ts)}</td>
    </tr>`;
  }
  if(rows.length===0){
    html += `<tr><td colspan="7" class="muted">暂无数据</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

async function loadReport(){
  const meta = document.getElementById('meta');
  const status = document.getElementById('status');

  const m1 = document.getElementById('m1');
  const m1_note = document.getElementById('m1_note');
  const m2 = document.getElementById('m2');
  const m3 = document.getElementById('m3');
  const m4 = document.getElementById('m4');
  const m5 = document.getElementById('m5');
  const m6 = document.getElementById('m6');
  const m7 = document.getElementById('m7');

  try{
    status.textContent = '状态：抓取中…';

    // ✅ 打开即最新关键：禁用缓存 + URL 加时间戳
    const url = 'latest_report.json?t=' + Date.now();
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP ' + r.status + ' ' + r.statusText);

    const data = await r.json();

    // 头部元信息
    const symbol = data.symbol || data.code || data.ticker || '02618.HK';
    const date   = data.trade_date || data.date || data.tradeDate || data.trading_date || '未知';
    const genBjt = data.generated_at_bjt || data.generated_at || data.generatedAt || '';
    const pageTs = new Date().toISOString();

    meta.innerHTML = `
      <div class="row">
        <div class="badge">代码：${esc(symbol)}</div>
        <div class="badge">时间：${esc(date)}</div>
        <div class="badge">页面刷新：${esc(pageTs)}</div>
      </div>
      <div style="margin-top:8px">
        数据源：/latest_report.json（no-store + 时间戳防缓存）
        ${genBjt ? `｜报告生成时间：${esc(genBjt)}` : ``}
      </div>
    `;

    // ① 当日实际交易数据
    const mk = data.module_1_market || {};
    const raw = mk.raw || {};
    const src = mk.source_url || '';
    const fetched = mk.fetched_at_bjt || '';
    const reason = data.report_reason || data.reason || '';

    m1.innerHTML = tableKV([
      ['代码', esc(mk.symbol || symbol)],
      ['交易日', esc(mk.trade_date || date)],
      ['开盘价', `<span class="mono">${esc(fmtNum(mk.open,2))}</span>`],
      ['最高价', `<span class="mono">${esc(fmtNum(mk.high,2))}</span>`],
      ['最低价', `<span class="mono">${esc(fmtNum(mk.low,2))}</span>`],
      ['收盘价', `<span class="mono">${esc(fmtNum(mk.close,2))}</span>`],
      ['成交量', `<span class="mono">${esc(fmtInt(mk.volume))}</span>`],
      ['成交额', `<span class="mono">${esc(fmtMoney(mk.turnover,2))}</span>`],
    ]);

    m1_note.innerHTML = `
      <div class="hr"></div>
      <div class="note">
        备注：数据抓取时间（BJT）= <span class="mono">${esc(fetched || '—')}</span><br/>
        备注：数据源链接 = <span class="mono">${esc(src || '—')}</span><br/>
        备注：系统说明 = ${esc(reason || '—')} 

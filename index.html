<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京东物流 V1.0 法定预测报告</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111;
      --muted:#667085;
      --line:#e6e8eb;
      --shadow:0 1px 2px rgba(0,0,0,.04);

      /* 字号：标题 14 / 内容 12 */
      --fs-title:14px;
      --fs-body:12px;

      --ok-bg:#ecfdf3;
      --ok-tx:#0a6a2b;
      --fail-bg:#fff1f0;
      --fail-tx:#b42318;
      --tag-bg:#f0f2f5;
      --tag-tx:#444;
    }

    *{box-sizing:border-box}

    body{
      margin:18px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:1.6;
    }

    .wrap{max-width:1480px;margin:0 auto}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:18px;
      margin:14px 0;
      box-shadow:var(--shadow);
    }

    /* 顶部主标题：14px */
    h1{
      font-size:var(--fs-title);
      margin:0 0 8px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.45;
    }

    /* 模块标题：14px */
    h2{
      font-size:var(--fs-title);
      margin:0 0 10px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .meta{
      color:var(--muted);
      font-size:var(--fs-body);
      font-weight:600;
    }

    .small{
      font-size:var(--fs-body);
      color:var(--muted);
      line-height:1.6;
      font-weight:500;
      word-break:break-word;
    }

    .bad{
      background:#fff5f5;
      border-color:#ffd6d6;
    }
    .bad .meta{color:var(--fail-tx)}

    .rowTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .rowTopLeft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tag{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:var(--tag-bg);
      font-size:var(--fs-body);
      color:var(--tag-tx);
      font-weight:800;
      line-height:1.7;
      border:1px solid var(--line);
    }
    .ok{background:var(--ok-bg); color:var(--ok-tx); border-color:#b7ebc6}
    .fail{background:var(--fail-bg); color:var(--fail-tx); border-color:#fda29b}

    .pill{
      display:inline-block;
      padding:2px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:var(--fs-body);
      color:#344054;
      background:#fff;
      font-weight:800;
      line-height:1.7;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
    }

    thead th{
      text-align:left;
      font-weight:900;
      padding:10px 10px;
      border-bottom:2px solid var(--line);
      font-size:var(--fs-title); /* 表头=标题 14 */
      background:#fafafa;
      white-space:nowrap;
    }

    tbody td{
      border-bottom:1px solid #eee;
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
      font-weight:600;
      font-size:var(--fs-body);
    }

    .scrollX{overflow:auto}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* ③ 次日分布：值靠左对齐（如果你想全部居中，把这里删掉） */
    #m3c th, #m3c td { text-align:left !important; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card" id="top">
    <div class="rowTop">
      <div class="rowTopLeft">
        <h1 style="margin:0;">京东物流 V1.0 法定预测报告</h1>
        <span class="tag" id="statusTag">加载中</span>
        <span class="pill" id="pill_fetch">DATA: --</span>
        <span class="pill" id="pill_parse">PARSE: --</span>
        <span class="pill" id="pill_render">RENDER: --</span>
      </div>
      <div class="small" id="last_update">Last update: --</div>
    </div>

    <div class="divider"></div>

    <div class="meta" id="metaLine">正在读取 report_latest.md ...</div>
    <div class="small" id="hint"></div>
  </div>

  <div class="card"><h2>① 当日实际交易数据</h2><div id="m1c"></div></div>
  <div class="card"><h2>② 昨日预测回顾</h2><div id="m2c"></div></div>
  <div class="card"><h2>③ 次日价格分布预测</h2><div id="m3c"></div></div>
  <div class="card"><h2>④ 未来 1 个月价格分布预测</h2><div id="m4c"></div></div>
  <div class="card"><h2>⑤ 未来 6 个月价格分布预测</h2><div id="m5c"></div></div>
  <div class="card"><h2>⑥ 模型状态与学习更新</h2><div id="m6c"></div></div>
  <div class="card"><h2>⑦ 过去五个交易日预测命中回顾</h2><div id="m7c"></div></div>

  <div class="card">
    <div class="small">
      <b>合规声明：</b><br>
      本报告严格遵循“真实数据优先”与“不得回填 / 估算”原则生成。<br>
      若当日真实交易数据不可得，系统将输出完整法定界面结构，并明确标注为占位状态，不进行任何形式的数据推断或补全。
    </div>
  </div>

</div>

<script>
/* =========================================================
 *  1) 配置区：只读 report_latest.md（同目录）
 * ========================================================= */
const CONFIG = {
  REPORT_MD_URL: 'report_latest.md',
  AUTO_REFRESH_MS: 60000
};

/* =========================================================
 *  2) DOM
 * ========================================================= */
const $ = (id) => document.getElementById(id);
const UI = {
  topCard: () => $('top'),
  statusTag: () => $('statusTag'),
  hint: () => $('hint'),
  metaLine: () => $('metaLine'),
  lastUpdate: () => $('last_update'),
  pillFetch: () => $('pill_fetch'),
  pillParse: () => $('pill_parse'),
  pillRender: () => $('pill_render'),
  m1: () => $('m1c'),
  m2: () => $('m2c'),
  m3: () => $('m3c'),
  m4: () => $('m4c'),
  m5: () => $('m5c'),
  m6: () => $('m6c'),
  m7: () => $('m7c')
};

function markPill(el, ok, text){
  if(!el) return;
  el.textContent = text;
  el.style.borderColor = ok ? "#b7ebc6" : "#fda29b";
  el.style.color = ok ? "#027a48" : "#b42318";
}

function escapeHtml(input){
  return String(input)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function smallEmpty(text='暂无数据'){
  return `<div class="small">${escapeHtml(text)}</div>`;
}

/* =========================================================
 *  3) 读取 MD：fetch text（cache bust）
 * ========================================================= */
async function fetchText(url){
  const u = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
  const r = await fetch(u, { cache: 'no-store' });
  if(!r.ok) throw new Error('HTTP ' + r.status);
  return await r.text();
}

/* =========================================================
 *  4) 从 report_latest.md 抽取：顶部 meta + ①~⑦ 表格
 *     关键：MD 里的表格是真实 <table>...</table>
 * ========================================================= */
function pickLine(md, prefix){
  const safe = prefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const m = md.match(new RegExp('^' + safe + '\\s*(.*)$', 'm'));
  return m ? (m[1] || '').trim() : '';
}

function pickTitle(md){
  const m = md.match(/^(.+)\r?\n/m);
  return m ? m[1].trim() : '京东物流 V1.0 法定预测报告';
}

function pickSectionTable(md, sectionTitle){
  const idx = md.indexOf(sectionTitle);
  if(idx < 0) return '';
  const tail = md.slice(idx);
  const t = tail.match(/<table[\s\S]*?<\/table>/i);
  return t ? t[0] : '';
}

function normalizeMD(md){
  return md.replace(/\r/g, '');
}

function parseReportLatestMD(mdRaw){
  const md = normalizeMD(mdRaw);

  const title = pickTitle(md);
  const code = pickLine(md, '代码：');
  const tradeDate = pickLine(md, '交易日：');
  const genTime = pickLine(md, '报告生成时间(BJT)：');

  let dataSource = '';
  const dsMatch = md.match(/^数据源：\s*(.*)$/m);
  if(dsMatch) dataSource = dsMatch[1].trim();

  const m1 = pickSectionTable(md, '① 当日实际交易数据');
  const m2 = pickSectionTable(md, '② 昨日预测回顾');
  const m3 = pickSectionTable(md, '③ 次日价格分布预测');
  const m4 = pickSectionTable(md, '④ 未来1个月价格分布预测');
  const m5 = pickSectionTable(md, '⑤ 未来6个月价格分布预测');
  const m6 = pickSectionTable(md, '⑥ 模型状态与学习更新');
  const m7 = pickSectionTable(md, '⑦ 过去五个交易日预测命中回顾');

  return { title, code, tradeDate, genTime, dataSource, m1, m2, m3, m4, m5, m6, m7 };
}

/* =========================================================
 *  5) 渲染
 * ========================================================= */
function setStatus(ok, text, hint){
  UI.statusTag().textContent = text;
  UI.statusTag().className = ok ? 'tag ok' : 'tag fail';
  UI.topCard().className = ok ? 'card' : 'card bad';
  UI.hint().textContent = hint || '';
}

function stripTags(s){
  return String(s || '').replace(/<[^>]*>/g, '');
}

function renderFromParsed(p){
  const meta = [
    `股票代码：${p.code || '—'}`,
    `交易日：${p.tradeDate || '—'}`,
    `报告生成时间(BJT)：${p.genTime || '—'}`
  ].join(' ｜ ');
  UI.metaLine().textContent = meta;

  UI.m1().innerHTML = p.m1 ? `<div class="scrollX">${p.m1}</div>` : smallEmpty('未在 report_latest.md 中找到 ① 的表格');
  UI.m2().innerHTML = p.m2 ? `<div class="scrollX">${p.m2}</div>` : smallEmpty('未在 report_latest.md 中找到 ② 的表格');
  UI.m3().innerHTML = p.m3 ? `<div class="scrollX">${p.m3}</div>` : smallEmpty('未在 report_latest.md 中找到 ③ 的表格');
  UI.m4().innerHTML = p.m4 ? `<div class="scrollX">${p.m4}</div>` : smallEmpty('未在 report_latest.md 中找到 ④ 的表格');
  UI.m5().innerHTML = p.m5 ? `<div class="scrollX">${p.m5}</div>` : smallEmpty('未在 report_latest.md 中找到 ⑤ 的表格');
  UI.m6().innerHTML = p.m6 ? `<div class="scrollX">${p.m6}</div>` : smallEmpty('未在 report_latest.md 中找到 ⑥ 的表格');
  UI.m7().innerHTML = p.m7 ? `<div class="scrollX">${p.m7}</div>` : smallEmpty('未在 report_latest.md 中找到 ⑦ 的表格');
}

/* =========================================================
 *  6) 主流程：load -> parse -> render
 * ========================================================= */
async function loadAndRender(){
  markPill(UI.pillFetch(), true, 'DATA: LOADING');
  markPill(UI.pillParse(), true, 'PARSE: --');
  markPill(UI.pillRender(), true, 'RENDER: --');

  try{
    const md = await fetchText(CONFIG.REPORT_MD_URL);
    markPill(UI.pillFetch(), true, 'DATA: OK');

    let parsed;
    try{
      parsed = parseReportLatestMD(md);
      markPill(UI.pillParse(), true, 'PARSE: OK');
    }catch(e){
      markPill(UI.pillParse(), false, 'PARSE: FAIL');
      setStatus(false, '解析失败', 'report_latest.md 解析失败：' + (e?.message || '未知错误'));
      return;
    }

    try{
      renderFromParsed(parsed);
      markPill(UI.pillRender(), true, 'RENDER: OK');

      const hint = parsed.dataSource ? ('数据源：' + stripTags(parsed.dataSource)) : '';
      setStatus(true, '报告有效', hint);

      UI.lastUpdate().textContent = 'Last update: ' + new Date().toISOString();
    }catch(e){
      markPill(UI.pillRender(), false, 'RENDER: FAIL');
      setStatus(false, '渲染失败', '渲染失败：' + (e?.message || '未知错误'));
      return;
    }

  }catch(e){
    markPill(UI.pillFetch(), false, 'DATA: FAIL');
    markPill(UI.pillParse(), false, 'PARSE: --');
    markPill(UI.pillRender(), false, 'RENDER: --');

    setStatus(false, '数据未就绪',
      '无法读取 report_latest.md（请确认文件存在于同目录，并已提交到 main 分支）：' + (e?.message || '未知错误')
    );

    UI.metaLine().textContent = '法定界面已输出（report_latest.md 不可访问）';
    UI.m1().innerHTML = smallEmpty();
    UI.m2().innerHTML = smallEmpty();
    UI.m3().innerHTML = smallEmpty();
    UI.m4().innerHTML = smallEmpty();
    UI.m5().innerHTML = smallEmpty();
    UI.m6().innerHTML = smallEmpty();
    UI.m7().innerHTML = smallEmpty();
    UI.lastUpdate().textContent = 'Last update: --';
  }
}

/* =========================================================
 *  7) 启动 & 定时刷新
 * ========================================================= */
loadAndRender();
setInterval(loadAndRender, CONFIG.AUTO_REFRESH_MS);
</script>
</body>
</html>

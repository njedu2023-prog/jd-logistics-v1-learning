<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>äº¬ä¸œç‰©æµ V1.0 æ³•å®šé¢„æµ‹æŠ¥å‘Š</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:24px; line-height:1.5;}
    .wrap{max-width:980px;margin:0 auto;}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px 18px;margin:14px 0;}
    h1{margin:0 0 8px;}
    h2{margin:18px 0 10px;}
    .meta{color:#374151;font-size:14px;}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#f3f4f6;margin-right:8px;}
    table{width:100%;border-collapse:collapse;margin:8px 0;}
    th,td{border:1px solid #e5e7eb;padding:8px 10px;font-size:14px;}
    th{background:#f9fafb;text-align:left;}
    .ok{color:#065f46;font-weight:600;}
    .bad{color:#991b1b;font-weight:600;}
    .muted{color:#6b7280;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;}
    .btn:hover{background:#f9fafb;}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="align-items:center;justify-content:space-between;">
    <div>
      <h1>äº¬ä¸œç‰©æµ V1.0 æ³•å®šé¢„æµ‹æŠ¥å‘Š ğŸ“˜</h1>
      <div class="meta">
        <span class="pill" id="symbol">symbol: -</span>
        <span class="pill" id="tradeDate">trade_date: -</span>
        <span class="pill" id="generatedAt">generated_at_bjt: -</span>
      </div>
      <div class="meta" style="margin-top:6px;">
        æ•°æ®æºï¼š<a id="dataSource" href="#" target="_blank" rel="noreferrer">-</a>
        <span class="muted" id="reason" style="margin-left:10px;"></span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="refreshBtn">åˆ·æ–°æ•°æ®</button>
      <a class="btn" id="rawJsonBtn" href="latest_report.json" target="_blank" rel="noreferrer">æ‰“å¼€ latest_report.json</a>
    </div>
  </div>

  <div class="card" id="statusCard">
    <b>çŠ¶æ€ï¼š</b><span id="statusText">åŠ è½½ä¸­â€¦</span>
  </div>

  <div class="card">
    <h2>â‘  å½“æ—¥å®é™…äº¤æ˜“æ•°æ® ğŸ“Š</h2>
    <div id="marketTable"></div>
  </div>

  <div class="card">
    <h2>â‘¡ æ˜¨æ—¥é¢„æµ‹å›é¡¾ âœ…</h2>
    <div id="evalTable"></div>
  </div>

  <div class="card">
    <h2>â‘¢ æ¬¡æ—¥ä»·æ ¼åˆ†å¸ƒé¢„æµ‹ï¼ˆT+1ï¼‰ ğŸ”®</h2>
    <div id="distT1"></div>
  </div>

  <div class="card">
    <h2>â‘£ æœªæ¥ 1 ä¸ªæœˆä»·æ ¼åˆ†å¸ƒé¢„æµ‹ ğŸ—“ï¸</h2>
    <div id="dist1M"></div>
  </div>

  <div class="card">
    <h2>â‘¤ æœªæ¥ 6 ä¸ªæœˆä»·æ ¼åˆ†å¸ƒé¢„æµ‹ ğŸ§­</h2>
    <div id="dist6M"></div>
  </div>

  <div class="card">
    <h2>â‘¥ æ¨¡å‹çŠ¶æ€ä¸å­¦ä¹ æ›´æ–° âš™ï¸</h2>
    <div id="stateTable"></div>
  </div>

  <div class="card">
    <h2>â‘¦ æœ€è¿‘ 5 ä¸ªäº¤æ˜“æ—¥é¢„æµ‹å‘½ä¸­å›é¡¾ ğŸ§¾</h2>
    <div id="last5Table"></div>
  </div>

  <div class="card">
    <h2>è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</h2>
    <div class="muted">å¦‚æœé¡µé¢æ˜¾ç¤ºå¼‚å¸¸ï¼Œå¯æŠŠä¸‹é¢å†…å®¹æˆªå›¾å‘æˆ‘ã€‚</div>
    <pre id="debugBox">-</pre>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    if (s === null || s === undefined) return "";
    return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function kvTable(obj, rows){
    let html = `<table><thead><tr><th>å­—æ®µ</th><th>æ•°å€¼</th></tr></thead><tbody>`;
    for (const [k, key] of rows){
      const v = (key === null) ? "" : (obj?.[key] ?? "");
      html += `<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(v)}</td></tr>`;
    }
    html += `</tbody></table>`;
    return html;
  }

  function distTableFromArray(arr){
    // æœŸæœ›: [{p:0.05,v:...}, ...]
    if (!Array.isArray(arr) || arr.length === 0) return `<div class="muted">æ— æ•°æ®</div>`;
    let html = `<table><thead><tr><th>åˆ†ä½</th><th>ä»·æ ¼(HKD)</th></tr></thead><tbody>`;
    for (const r of arr){
      const p = r?.p;
      const label = (p === 0.05) ? "P05" : (p === 0.25) ? "P25" : (p === 0.5) ? "P50" : (p === 0.75) ? "P75" : (p === 0.95) ? "P95" : `P${Math.round(p*100)}`;
      html += `<tr><td>${label}</td><td>${escapeHtml(r?.v ?? "")}</td></tr>`;
    }
    html += `</tbody></table>`;
    return html;
  }

  function last5Table(rows){
    if (!Array.isArray(rows) || rows.length === 0) return `<div class="muted">æš‚æ— å†å²</div>`;
    let html = `<table><thead><tr>
      <th>é¢„æµ‹æ—¥æœŸ</th><th>å®é™…æ—¥æœŸ</th><th>é¢„æµ‹P50</th><th>å®é™…æ”¶ç›˜</th><th>è¯¯å·®</th><th>å‘½ä¸­åŒºé—´</th><th>åˆ¤æ–­</th>
    </tr></thead><tbody>`;
    for (const r of rows){
      html += `<tr>
        <td>${escapeHtml(r?.y_pred_trade_date ?? "")}</td>
        <td>${escapeHtml(r?.today_trade_date ?? "")}</td>
        <td>${escapeHtml(r?.y_pred_p50 ?? "")}</td>
        <td>${escapeHtml(r?.today_close ?? "")}</td>
        <td>${escapeHtml(r?.error ?? "")}</td>
        <td>${escapeHtml(r?.hit_band ?? "")}</td>
        <td>${escapeHtml(r?.judgment ?? "")}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    return html;
  }

  async function loadLatest(){
    $("statusText").textContent = "åŠ è½½ä¸­â€¦";
    $("debugBox").textContent = "-";

    // å…³é”®ï¼šåŠ æ—¶é—´æˆ³ï¼Œé¿å…æµè§ˆå™¨/Pages/CDN ç¼“å­˜å¯¼è‡´è¯»åˆ°æ—§ JSON
    const url = `latest_report.json?ts=${Date.now()}`;

    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();

      // é¡¶éƒ¨ meta
      $("symbol").textContent = `symbol: ${data.symbol ?? "-"}`;
      $("tradeDate").textContent = `trade_date: ${data.trade_date ?? "-"}`;
      $("generatedAt").textContent = `generated_at_bjt: ${data.generated_at_bjt ?? "-"}`;
      $("reason").textContent = data.report_reason ? `å¤‡æ³¨ï¼š${data.report_reason}` : "";

      const sourceUrl = data?.module_1_market?.source_url || data?.module_1_market?.source || data?.data_source_url || "-";
      $("dataSource").textContent = sourceUrl;
      $("dataSource").href = (sourceUrl && sourceUrl !== "-") ? sourceUrl : "#";

      // çŠ¶æ€
      const ok = String(data.status || "").toUpperCase() === "SUCCESS";
      $("statusText").innerHTML = ok
        ? `<span class="ok">SUCCESS</span>`
        : `<span class="bad">${escapeHtml(data.status ?? "UNKNOWN")}</span>`;

      // æ¨¡å—ï¼šå¸‚åœº
      const m = data.module_1_market || {};
      $("marketTable").innerHTML = kvTable(m, [
        ["ä»£ç ", "symbol"],
        ["äº¤æ˜“æ—¥", "trade_date"],
        ["å¼€ç›˜ä»·", "open"],
        ["æœ€é«˜ä»·", "high"],
        ["æœ€ä½ä»·", "low"],
        ["æ”¶ç›˜ä»·", "close"],
        ["æˆäº¤é‡", "volume"],
        ["æˆäº¤é¢", "turnover"],
        ["æŠ“å–æ—¶é—´(BJT)", "fetched_at_bjt"],
        ["æ•°æ®æº", "source_url"],
      ]);

      // æ¨¡å—ï¼šå›é¡¾
      const e = data.module_2_yesterday_review || {};
      $("evalTable").innerHTML = kvTable(e, [
        ["æ˜¨æ—¥é¢„æµ‹ä¸­ä½ä»·(P50)", "y_pred_p50"],
        ["ä»Šæ—¥å®é™…æ”¶ç›˜ä»·", "today_close"],
        ["è¯¯å·®(å®é™…-é¢„æµ‹)", "error"],
        ["å‘½ä¸­åˆ†ä½åŒºé—´", "hit_band"],
        ["åˆ¤æ–­ç»“æœ", "judgment"],
        ["å›é¡¾åŸºäºé¢„æµ‹æ—¥æœŸ", "y_pred_trade_date"],
      ]);

      // åˆ†å¸ƒ
      $("distT1").innerHTML = distTableFromArray(data.module_3_t1_distribution);
      $("dist1M").innerHTML = distTableFromArray(data.module_4_1m_distribution);
      $("dist6M").innerHTML = distTableFromArray(data.module_5_6m_distribution);

      // çŠ¶æ€è¡¨
      const st = data.module_6_model_state || {};
      $("stateTable").innerHTML = kvTable(st, [
        ["ç³»ç»Ÿç‰ˆæœ¬", "model_version"],
        ["æ ‡çš„", "symbol"],
        ["çŠ¶æ€æ›´æ–°æ—¶é—´(BJT)", "updated_at_bjt"],
        ["EWMAå¹´åŒ–æ³¢åŠ¨ç‡(ä¼°è®¡)", "sigma_ewma_1m_ann"],
        ["æ—¥æ¼‚ç§»Î¼(ä¼°è®¡)", "mu_daily"],
        ["æœ€è¿‘æ ·æœ¬æ¡æ•°(ç”¨äºä¼°è®¡)", "return_samples"],
      ]);

      // last5
      $("last5Table").innerHTML = last5Table(data.module_7_last5_hit);

      $("debugBox").textContent = JSON.stringify({
        fetched_url: url,
        status: data.status,
        generated_at_bjt: data.generated_at_bjt,
        trade_date: data.trade_date
      }, null, 2);

    }catch(err){
      $("statusText").innerHTML = `<span class="bad">FAILED</span> ${escapeHtml(err?.message || err)}`;
      $("debugBox").textContent = String(err?.stack || err);
    }
  }

  $("refreshBtn").addEventListener("click", loadLatest);

  // é¡µé¢æ‰“å¼€è‡ªåŠ¨åŠ è½½
  loadLatest();
</script>
</body>
</html>

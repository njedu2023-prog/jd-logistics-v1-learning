<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京东物流 V1.0 法定预测报告</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111;
      --muted:#667085;
      --line:#e6e8eb;
      --shadow:0 1px 2px rgba(0,0,0,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:18px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
    }
    .wrap{max-width:1480px;margin:0 auto}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:18px;
      margin:14px 0;
      box-shadow:var(--shadow);
    }
    h1{
      font-size:32px;
      line-height:1.2;
      margin:0 0 14px 0;
      font-weight:800;
      letter-spacing:.2px;
    }
    .meta{
      margin:0;
      padding-left:0;
      list-style:none;
      color:var(--text);
      font-size:20px;
      line-height:1.8;
    }
    .meta .k{font-weight:800;display:inline-block;min-width:140px}
    .meta .v{font-weight:600}
    .muted{color:var(--muted);font-weight:500}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .secTitle{
      font-size:26px;
      font-weight:900;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:22px;
    }
    thead th{
      text-align:left;
      font-weight:900;
      padding:16px 12px;
      border-bottom:2px solid var(--line);
    }
    tbody td{
      padding:18px 12px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      font-weight:600;
    }
    .twoCol thead th:nth-child(2),
    .twoCol tbody td:nth-child(2){
      text-align:left;
    }

    .smallNote{
      color:var(--muted);
      font-size:16px;
      line-height:1.6;
      margin-top:10px;
      font-weight:500;
    }

    .statusLine{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
    }
    .pill{
      display:inline-block;
      padding:3px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:13px;
      color:#344054;
      background:#fff;
      font-weight:700;
    }
    .error{
      color:#b42318;
      font-weight:800;
      font-size:14px;
    }
    .ok{
      color:#027a48;
      font-weight:800;
      font-size:14px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- 顶部标题 + 关键信息 -->
  <div class="card">
    <h1>京东物流 V1.0 法定预测报告</h1>
    <ul class="meta">
      <li><span class="k">标的：</span><span class="v" id="meta_symbol">--</span></li>
      <li><span class="k">交易日：</span><span class="v" id="meta_trade_date">--</span></li>
      <li><span class="k">报告生成时间（BJT）：</span><span class="v" id="meta_report_time">--</span></li>
      <li><span class="k">数据源：</span><span class="v" id="meta_source">--</span></li>
    </ul>
  </div>

  <!-- ① 当日实际交易数据 -->
  <div class="card">
    <div class="secTitle">① 当日实际交易数据</div>
    <table class="twoCol">
      <thead>
        <tr><th>指标</th><th>数值</th></tr>
      </thead>
      <tbody id="tbl_market"></tbody>
    </table>
  </div>

  <!-- ② 昨日预测回顾 -->
  <div class="card">
    <div class="secTitle">② 昨日预测回顾</div>
    <table class="twoCol">
      <thead>
        <tr><th>字段</th><th>数值</th></tr>
      </thead>
      <tbody id="tbl_review"></tbody>
    </table>
  </div>

  <!-- ③ 次日价格分布预测（T+1） -->
  <div class="card">
    <div class="secTitle">③ 次日价格分布预测（T+1）</div>
    <table>
      <thead>
        <tr><th>分位</th><th>价格（HKD）</th></tr>
      </thead>
      <tbody id="tbl_t1"></tbody>
    </table>
  </div>

  <!-- ④ 未来 1 个月价格分布预测 -->
  <div class="card">
    <div class="secTitle">④ 未来 1 个月价格分布预测</div>
    <table>
      <thead>
        <tr><th>分位</th><th>价格（HKD）</th></tr>
      </thead>
      <tbody id="tbl_m1"></tbody>
    </table>
  </div>

  <!-- ⑤ 未来 6 个月价格分布预测 -->
  <div class="card">
    <div class="secTitle">⑤ 未来 6 个月价格分布预测</div>
    <table>
      <thead>
        <tr><th>分位</th><th>价格（HKD）</th></tr>
      </thead>
      <tbody id="tbl_m6"></tbody>
    </table>
  </div>

  <!-- ⑥ 模型状态与学习更新 -->
  <div class="card">
    <div class="secTitle">⑥ 模型状态与学习更新</div>
    <table>
      <thead>
        <tr><th>类别</th><th>字段</th><th>数值</th></tr>
      </thead>
      <tbody id="tbl_status"></tbody>
    </table>

    <div class="statusLine">
      <span class="pill" id="pill_fetch">DATA: --</span>
      <span class="pill" id="pill_parse">PARSE: --</span>
      <span class="pill" id="pill_render">RENDER: --</span>
      <span class="muted" id="last_update">--</span>
    </div>

    <div class="smallNote" id="note_msg"></div>
  </div>

  <!-- ⑦ 过去五个交易日预测命中回顾 -->
  <div class="card">
    <div class="secTitle">⑦ 过去五个交易日预测命中回顾</div>
    <table>
      <thead>
        <tr>
          <th>预测日期</th>
          <th>实际日期</th>
          <th>预测 P50</th>
          <th>实际收盘</th>
          <th>误差</th>
          <th>命中区间</th>
          <th>判断</th>
        </tr>
      </thead>
      <tbody id="tbl_last5"></tbody>
    </table>
  </div>

</div>

<script>
  // ====== 配置：你的数据源 ======
  const DATA_URL = "https://raw.githubusercontent.com/njedu2023-prog/JD-data/main/jd-logistics-latest.json";

  // ====== 工具函数 ======
  function byId(id){ return document.getElementById(id); }

  function fmt(v, digits=null){
    if (v === null || v === undefined || v === "") return "--";
    if (typeof v === "number"){
      if (Number.isFinite(v)){
        return digits===null ? String(v) : v.toFixed(digits);
      }
      return "--";
    }
    return String(v);
  }

  function getAny(obj, paths){
    // paths: ["a.b.c","x.y","k"]
    for (const p of paths){
      const parts = p.split(".");
      let cur = obj;
      let ok = true;
      for (const key of parts){
        if (cur && Object.prototype.hasOwnProperty.call(cur, key)){
          cur = cur[key];
        }else{
          ok = false; break;
        }
      }
      if (ok && cur !== undefined && cur !== null) return cur;
    }
    return null;
  }

  function setKVTable(tbodyEl, rows){
    // rows: [{k:"字段", v:"值"}]
    tbodyEl.innerHTML = rows.map(r => `
      <tr>
        <td>${r.k}</td>
        <td>${r.v}</td>
      </tr>
    `).join("");
  }

  function setQuantTable(tbodyEl, q){
    // q can be object: {P05:..., P25:..., P50:..., P75:..., P95:...}
    const order = ["P05","P25","P50","P75","P95"];
    const rows = order.map(k => ({
      q: k,
      v: fmt(q && (q[k] ?? q[k.toLowerCase()]), 3)
    }));
    tbodyEl.innerHTML = rows.map(r => `
      <tr>
        <td>${r.q === "P50" ? "P50（中位）" : r.q}</td>
        <td>${r.v}</td>
      </tr>
    `).join("");
  }

  function setStatusRows(tbodyEl, rows){
    tbodyEl.innerHTML = rows.map(r => `
      <tr>
        <td>${r.cat}</td>
        <td>${r.field}</td>
        <td>${r.val}</td>
      </tr>
    `).join("");
  }

  function setLast5(tbodyEl, arr){
    if (!Array.isArray(arr) || arr.length === 0){
      tbodyEl.innerHTML = `
        <tr>
          <td colspan="7" class="muted" style="padding:18px 12px;">--</td>
        </tr>`;
      return;
    }
    tbodyEl.innerHTML = arr.slice(0,5).map(it => {
      const predDate = fmt(getAny(it, ["pred_date","predict_date","date","prediction_date"]), null);
      const actDate  = fmt(getAny(it, ["actual_date","real_date","trade_date"]), null);
      const p50      = fmt(getAny(it, ["p50","pred_p50","predict_p50","median"]), 3);
      const close    = fmt(getAny(it, ["close","actual_close","real_close"]), 3);
      const err      = fmt(getAny(it, ["error","diff","delta"]), 3);
      const band     = fmt(getAny(it, ["hit_band","band","hit_interval"]), null);
      const judge    = fmt(getAny(it, ["judge","judgement","result"]), null);
      return `
        <tr>
          <td>${predDate}</td>
          <td>${actDate}</td>
          <td>${p50}</td>
          <td>${close}</td>
          <td>${err}</td>
          <td>${band}</td>
          <td>${judge}</td>
        </tr>
      `;
    }).join("");
  }

  function markPill(id, ok, text){
    const el = byId(id);
    el.textContent = text;
    el.style.borderColor = ok ? "#b7ebc6" : "#fda29b";
    el.style.color = ok ? "#027a48" : "#b42318";
  }

  // ====== 渲染主逻辑 ======
  async function loadAndRender(){
    markPill("pill_fetch", true, "DATA: LOADING");
    markPill("pill_parse", true, "PARSE: --");
    markPill("pill_render", true, "RENDER: --");
    byId("note_msg").textContent = "";

    let data = null;
    try{
      const url = DATA_URL + "?t=" + Date.now(); // 强制拿最新
      const res = await fetch(url, {cache:"no-store"});
      if (!res.ok) throw new Error("HTTP " + res.status);
      data = await res.json();
      markPill("pill_fetch", true, "DATA: OK");
    }catch(e){
      markPill("pill_fetch", false, "DATA: FAIL");
      byId("note_msg").innerHTML = `<span class="error">数据拉取失败：</span>${fmt(e && e.message)}<br><span class="muted">请检查 Raw JSON 是否可访问、文件是否为有效 JSON。</span>`;
      byId("last_update").textContent = "Last update: --";
      return;
    }

    // 解析阶段
    try{
      // 顶部元信息（多路径兼容）
      const symbol = getAny(data, ["symbol","code","ticker","meta.symbol"]);
      const tradeDate = getAny(data, ["trade_date","date","trading_day","meta.trade_date"]);
      const reportTime = getAny(data, ["report_time_bjt","generated_time_bjt","report_time","meta.report_time_bjt","run_time_bjt"]);
      const source = getAny(data, ["data_source","source","market_url","meta.data_source","market.source"]);

      byId("meta_symbol").textContent = fmt(symbol);
      byId("meta_trade_date").textContent = fmt(tradeDate);
      byId("meta_report_time").textContent = fmt(reportTime);
      byId("meta_source").textContent = fmt(source ?? DATA_URL);

      // ① 当日实际交易数据
      const market = getAny(data, ["market","daily","today","actual","data.market"]) || data;
      const rowsMarket = [
        {k:"代码", v: fmt(getAny(market, ["symbol","code","ticker"]) ?? symbol)},
        {k:"交易日", v: fmt(getAny(market, ["trade_date","date"]) ?? tradeDate)},
        {k:"开盘价（HKD）", v: fmt(getAny(market, ["open","open_price","open_hkd"]), 2)},
        {k:"最高价（HKD）", v: fmt(getAny(market, ["high","high_price","high_hkd"]), 2)},
        {k:"最低价（HKD）", v: fmt(getAny(market, ["low","low_price","low_hkd"]), 2)},
        {k:"收盘价（HKD）", v: fmt(getAny(market, ["close","close_price","close_hkd"]), 2)},
        {k:"成交量（万股）", v: fmt(getAny(market, ["volume_wan","vol_wan","volume_10k","volumeWan"]), 2)},
        {k:"成交额（亿港元）", v: fmt(getAny(market, ["amount_yi","turnover_yi","amount_100m","amountYi"]), 4)},
        {k:"数据源", v: fmt(source ?? DATA_URL)},
        {k:"抓取时间（BJT）", v: fmt(getAny(market, ["fetch_time_bjt","captured_time_bjt","grab_time_bjt","capture_time"]) ?? reportTime)}
      ];
      setKVTable(byId("tbl_market"), rowsMarket);

      // ② 昨日预测回顾
      const review = getAny(data, ["review","yesterday_review","backtest","data.review"]) || data;
      const rowsReview = [
        {k:"昨日预测中位价 P50（HKD）", v: fmt(getAny(review, ["y_pred_p50","prev_p50","pred_p50","p50_yesterday","review.p50"]), 3)},
        {k:"今日实际收盘价（HKD）", v: fmt(getAny(review, ["actual_close","close","today_close","real_close","review.actual_close"]), 3)},
        {k:"误差（实际 - 预测）（HKD）", v: fmt(getAny(review, ["error","diff","delta","review.error"]), 3)},
        {k:"命中分位区间", v: fmt(getAny(review, ["hit_band","band","hit_interval","review.hit_band"]))},
        {k:"判断结果", v: fmt(getAny(review, ["judge","judgement","result","review.judge"]))},
        {k:"回顾基于预测日期", v: fmt(getAny(review, ["base_pred_date","pred_date","review_date","review.base_date"]) ?? tradeDate)}
      ];
      setKVTable(byId("tbl_review"), rowsReview);

      // ③/④/⑤ 分布
      const t1 = getAny(data, ["dist_t1","t1","next_day","t_plus_1","distribution.t1"]) || {};
      const m1 = getAny(data, ["dist_1m","m1","one_month","distribution.m1"]) || {};
      const m6 = getAny(data, ["dist_6m","m6","six_month","distribution.m6"]) || {};

      setQuantTable(byId("tbl_t1"), t1);
      setQuantTable(byId("tbl_m1"), m1);
      setQuantTable(byId("tbl_m6"), m6);

      // ⑥ 模型状态与学习更新（按你截图那种三列）
      const st = getAny(data, ["model_status","status","meta","model","data.status"]) || {};
      const factors = getAny(data, ["factors","constraints","switches","flags"]) || {};
      const learning = getAny(data, ["learning","learn","self_learning"]) || {};

      const statusRows = [
        {cat:"系统", field:"系统版本", val: fmt(getAny(st, ["system_version","version"]) ?? "V1.0")},
        {cat:"系统", field:"运行类型", val: fmt(getAny(st, ["run_type","type"]) ?? getAny(data, ["run_type"]))},
        {cat:"系统", field:"本次运行时间（BJT）", val: fmt(getAny(st, ["run_time_bjt","time_bjt"]) ?? reportTime)},
        {cat:"系统", field:"模型执行状态", val: fmt(getAny(st, ["exec_status","status","result"]) ?? "SUCCESS")},
        {cat:"系统", field:"数据源完整性校验", val: fmt(getAny(st, ["data_integrity","integrity_check"]) ?? "通过")},

        {cat:"波动率建模", field:"1 个月波动率（EWMA，年化）", val: fmt(getAny(st, ["vol_1m","sigma_1m","ewma_vol_1m"]), 2)},
        {cat:"波动率建模", field:"6 个月波动率（EWMA，年化）", val: fmt(getAny(st, ["vol_6m","sigma_6m","ewma_vol_6m"]), 2)},
        {cat:"波动率建模", field:"EWMA 衰减系数 λ", val: fmt(getAny(st, ["ewma_lambda","lambda"]), 2)},
        {cat:"波动率建模", field:"波动率样本窗口（交易日）", val: fmt(getAny(st, ["vol_window_days","window_days","sample_window_days"]))},

        {cat:"收益分布", field:"日收益漂移 μ（估计）", val: fmt(getAny(st, ["mu_daily","mu","drift"]), 6)},
        {cat:"收益分布", field:"收益分布假设", val: fmt(getAny(st, ["dist_assumption","dist","assumption"]) ?? "对数正态")},
        {cat:"收益分布", field:"厚尾建模", val: fmt(getAny(st, ["tail_model","tail"]) ?? "t 分布")},
        {cat:"收益分布", field:"厚尾参数 ν（自由度）", val: fmt(getAny(st, ["nu","dof","t_nu"]), 2)},

        {cat:"因子与约束", field:"是否启用成交量因子", val: fmt(getAny(factors, ["use_volume","enable_volume","volume_factor"]) ?? "否")},
        {cat:"因子与约束", field:"是否启用 β 锚定", val: fmt(getAny(factors, ["use_beta","enable_beta","beta_anchor"]) ?? "否")},
        {cat:"因子与约束", field:"是否引入指数/行业因子", val: fmt(getAny(factors, ["use_index","enable_index","index_factor"]) ?? "否")},
        {cat:"因子与约束", field:"是否进行人工干预", val: fmt(getAny(factors, ["manual_override","manual","human_intervention"]) ?? "否")},

        {cat:"学习机制", field:"模型是否自学习", val: fmt(getAny(learning, ["self_learning","enabled"]) ?? "是（基于历史追加）")},
        {cat:"学习机制", field:"是否回填或估算真实市场数据", val: fmt(getAny(learning, ["backfill","estimate_market_data"]) ?? "否（严格禁止）")},
        {cat:"学习机制", field:"历史预测用于回顾评估", val: fmt(getAny(learning, ["history_eval","use_history_for_eval"]) ?? "是")},

        {cat:"运行备注", field:"备注", val: fmt(getAny(st, ["remark","note","message"]) ?? "—")}
      ];
      setStatusRows(byId("tbl_status"), statusRows);

      // ⑦ 过去五日
      const last5 = getAny(data, ["last_5","past_5","history_5","recent5","hit_review_5"]) || [];
      setLast5(byId("tbl_last5"), last5);

      markPill("pill_parse", true, "PARSE: OK");
    }catch(e){
      markPill("pill_parse", false, "PARSE: FAIL");
      byId("note_msg").innerHTML = `<span class="error">数据解析失败：</span>${fmt(e && e.message)}`;
      byId("last_update").textContent = "Last update: --";
      return;
    }

    // 渲染完成
    try{
      markPill("pill_render", true, "RENDER: OK");
      byId("last_update").textContent = "Last update: " + new Date().toISOString();
      // 可选说明
      byId("note_msg").textContent = "说明：页面打开即拉取最新数据；若字段缺失显示 “--”。";
    }catch(e){
      markPill("pill_render", false, "RENDER: FAIL");
      byId("note_msg").innerHTML = `<span class="error">页面渲染失败：</span>${fmt(e && e.message)}`;
    }
  }

  // 页面加载即执行；并每 60 秒自动刷新一次（保持“永远最新”）
  loadAndRender();
  setInterval(loadAndRender, 60000);
</script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京东物流 V1.0 法定预测报告</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#ffffff;
      --page:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --head:#f3f4f6;
      --shadow:0 1px 2px rgba(0,0,0,.04);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--page);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:22px 16px 40px;
    }
    .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0 0 8px;
      line-height:1.25;
    }
    .submeta{
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      margin:0 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      box-shadow:var(--shadow);
      color:var(--muted);
    }
    .pill b{color:#111827;font-weight:700}
    .card{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin:14px 0;
      overflow:hidden;
    }
    .card-h{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .card-h h2{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.1px;
    }
    .card-b{padding:0}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    thead th{
      background:var(--head);
      color:#111827;
      font-weight:800;
      font-size:14px;
      text-align:left;
      padding:14px 18px;
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      font-size:15px;
    }
    tbody tr:last-child td{border-bottom:none}
    td.k{
      color:var(--muted);
      font-weight:700;
      width:44%;
      word-break:break-word;
    }
    td.v{
      color:#111827;
      font-weight:800;
      width:56%;
      text-align:left;
      word-break:break-word;
    }
    .note{
      padding:12px 18px 16px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
      background:#fff;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .status{
      padding:12px 18px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      box-shadow:var(--shadow);
      margin:10px 0 18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .status b{color:#111827}
    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      font-weight:800;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      box-shadow:var(--shadow);
      font-size:13px;
    }
    button:active{transform:translateY(1px)}
    .small{font-size:12px;color:var(--muted)}
    .err{
      color:#b91c1c;
      font-weight:800;
    }
    .foot{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
      line-height:1.8;
      text-align:left;
    }
    .sep{height:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <h1 class="title">京东物流 V1.0 法定预测报告</h1>

    <div class="submeta" id="meta">
      <span class="pill">状态：<b id="statusText">加载中…</b></span>
      <span class="pill">标的：<b id="symbolText">—</b></span>
      <span class="pill">最新交易日：<b id="tradeDateText">—</b></span>
      <span class="pill">报告生成时间（北京时间）：<b id="genTimeText">—</b></span>
    </div>

    <div class="status" id="statusBox">
      正在读取 <span class="mono" id="urlText">latest_report.json</span>（打开即最新，已做防缓存）…
      <div class="btnbar">
        <button id="btnRefresh" type="button">手动刷新</button>
        <button id="btnCopyUrl" type="button">复制数据源地址</button>
      </div>
      <div class="small">提示：如果你刚更新过数据，浏览器可能仍有缓存；本页面已加时间戳强制获取最新。</div>
    </div>

    <div id="app"></div>

    <div class="foot">
      数据说明：本页面仅展示仓库内 <span class="mono">latest_report.json</span> 的最新内容；所有字段以 JSON 为准。
    </div>
  </div>

<script>
(function(){
  // ✅ 只改这里：默认抓取同目录 latest_report.json（GitHub Pages 下最稳）
  const REPORT_URL = "./latest_report.json";

  const $ = (id)=>document.getElementById(id);

  const app = $("app");
  const statusText = $("statusText");
  const symbolText = $("symbolText");
  const tradeDateText = $("tradeDateText");
  const genTimeText = $("genTimeText");
  const statusBox = $("statusBox");
  const urlText = $("urlText");

  $("btnRefresh").addEventListener("click", ()=>load(true));
  $("btnCopyUrl").addEventListener("click", async ()=>{
    try{
      const full = new URL(REPORT_URL, location.href).toString();
      await navigator.clipboard.writeText(full);
      toast("已复制数据源地址");
    }catch(e){
      toast("复制失败（浏览器权限限制）");
    }
  });

  urlText.textContent = REPORT_URL;

  function toast(msg){
    const old = statusBox.querySelector(".__toast");
    if(old) old.remove();
    const div = document.createElement("div");
    div.className="__toast small";
    div.style.marginTop="8px";
    div.textContent = msg;
    statusBox.appendChild(div);
    setTimeout(()=>{ if(div) div.remove(); }, 1800);
  }

  function fmtNum(x, digits){
    if(x===null || x===undefined || x==="" || Number.isNaN(Number(x))) return "—";
    const n = Number(x);
    if(typeof digits === "number") return n.toFixed(digits);
    // 整数显示千分位，小数原样
    const isInt = Number.isInteger(n);
    return isInt ? n.toLocaleString("en-US") : n.toLocaleString("en-US");
  }

  function fmtDateTime(s){
    if(!s) return "—";
    // 保持原样（你系统已经输出 +0800）
    return String(s);
  }

  function toYuanYiHKD(amount){
    // amount: 港元（turnover），转为“亿港元”
    if(amount===null || amount===undefined || Number.isNaN(Number(amount))) return "—";
    const v = Number(amount) / 1e8;
    return v.toFixed(2);
  }

  function safeText(x){
    if(x===null || x===undefined) return "—";
    return String(x);
  }

  function el(tag, attrs={}, children=[]){
    const node = document.createElement(tag);
    for(const k in attrs){
      if(k==="class") node.className = attrs[k];
      else if(k==="html") node.innerHTML = attrs[k];
      else node.setAttribute(k, attrs[k]);
    }
    (Array.isArray(children)?children:[children]).forEach(ch=>{
      if(ch===null || ch===undefined) return;
      if(typeof ch==="string") node.appendChild(document.createTextNode(ch));
      else node.appendChild(ch);
    });
    return node;
  }

  function card(title){
    const c = el("div",{class:"card"});
    const h = el("div",{class:"card-h"}, el("h2",{}, title));
    const b = el("div",{class:"card-b"});
    c.appendChild(h); c.appendChild(b);
    return {c, b};
  }

  function tableKV(rows){
    const t = el("table");
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th",{}, "字段"));
    trh.appendChild(el("th",{}, "当前值"));
    thead.appendChild(trh);
    const tbody = el("tbody");
    rows.forEach(r=>{
      const tr = el("tr");
      tr.appendChild(el("td",{class:"k"}, r[0]));
      tr.appendChild(el("td",{class:"v"}, r[1]));
      tbody.appendChild(tr);
    });
    t.appendChild(thead);
    t.appendChild(tbody);
    return t;
  }

  function tableDistribution(arr){
    const t = el("table");
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th",{}, "分位"));
    trh.appendChild(el("th",{}, "价格（HKD）"));
    thead.appendChild(trh);
    const tbody = el("tbody");
    (arr||[]).forEach(it=>{
      const p = it && it.p;
      const v = it && it.v;
      const tr = el("tr");
      tr.appendChild(el("td",{class:"k"}, (p!=null?("P"+Math.round(Number(p)*100)):"—")));
      tr.appendChild(el("td",{class:"v"}, fmtNum(v, 3)));
      tbody.appendChild(tr);
    });
    t.appendChild(thead);
    t.appendChild(tbody);
    return t;
  }

  async function sha256Hex(str){
    try{
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
    }catch(e){
      return "—";
    }
  }

  function setTopMeta(d){
    statusText.textContent = safeText(d.status || "—");
    symbolText.textContent = safeText(d.symbol || "—");
    tradeDateText.textContent = safeText(d.trade_date || d.tradeDate || "—");
    genTimeText.textContent = fmtDateTime(d.generated_at_bjt || d.generated_at || d.generatedAt || "—");
  }

  function setStatusBoxOK(extra){
    statusBox.querySelectorAll(".__errline").forEach(n=>n.remove());
    if(extra){
      const div = el("div",{class:"__errline small"}, extra);
      div.style.marginTop="8px";
      statusBox.appendChild(div);
    }
  }

  function setStatusBoxError(msg){
    statusBox.querySelectorAll(".__errline").forEach(n=>n.remove());
    const div = el("div",{class:"__errline small"});
    div.style.marginTop="8px";
    div.innerHTML = '<span class="err">读取失败：</span>' + safeText(msg);
    statusBox.appendChild(div);
  }

  async function renderAll(d, rawText){
    app.innerHTML = "";

    // ① 当日实际交易数据（按你截图字段顺序/风格）
    const m1 = d.module_1_market || {};
    const {c: c1, b: b1} = card("① 当日实际交易数据");

    const dataSource = "github_raw_json";
    const sourceUrl = m1.source_url || "—";
    const fetchedAt = m1.fetched_at_bjt || "—";
    const fingerprint = await sha256Hex(rawText || JSON.stringify(d));

    const rows1 = [
      ["交易日期", safeText(m1.trade_date || d.trade_date || "—")],
      ["开盘价", fmtNum(m1.open, 2)],
      ["最高价", fmtNum(m1.high, 2)],
      ["最低价", fmtNum(m1.low, 2)],
      ["收盘价", fmtNum(m1.close, 2)],
      ["成交量", fmtNum(m1.volume, 0)],
      ["成交额（亿港元）", toYuanYiHKD(m1.turnover)],
      ["数据来源", dataSource],
      ["数据源地址", safeText(sourceUrl)],
      ["抓取时间（北京时间）", safeText(fetchedAt)],
      ["数据校验指纹", fingerprint]
    ];
    b1.appendChild(tableKV(rows1));

    // 底部备注（可选但不花哨）
    const note1 = el("div",{class:"note"},
      "说明：成交额（亿港元）= turnover ÷ 1e8；数据校验指纹为本次报告 JSON 的 SHA-256，用于防篡改核验。"
    );
    b1.appendChild(note1);
    app.appendChild(c1);

    // ② 昨日预测回顾
    const m2 = d.module_2_yesterday_review || null;
    const {c: c2, b: b2} = card("② 昨日预测回顾");
    if(m2){
      const rows2 = [
        ["预测对应交易日", safeText(m2.y_pred_trade_date)],
        ["实际交易日", safeText(m2.today_trade_date)],
        ["昨日预测中位价（P50）", fmtNum(m2.y_pred_p50, 3)],
        ["实际收盘价", fmtNum(m2.today_close, 2)],
        ["误差（实际-预测）", fmtNum(m2.error, 3)],
        ["命中分位区间", safeText(m2.hit_band)],
        ["判断结果", safeText(m2.judgment)],
        ["生成时间（北京时间）", fmtDateTime(m2.generated_at_bjt)]
      ];
      b2.appendChild(tableKV(rows2));
    }else{
      b2.appendChild(el("div",{class:"note"},"暂无 module_2_yesterday_review 数据。"));
    }
    app.appendChild(c2);

    // ③ 次日价格分布预测
    const {c: c3, b: b3} = card("③ 次日价格分布预测");
    b3.appendChild(tableDistribution(d.module_3_t1_distribution || []));
    b3.appendChild(el("div",{class:"note"},
      "含义：P5/P25/P50/P75/P95 分位点表示在当前模型假设下，次日价格落在该水平以下的概率分别为 5%/25%/50%/75%/95%。"
    ));
    app.appendChild(c3);

    // ④ 未来1个月价格分布预测
    const {c: c4, b: b4} = card("④ 未来1个月价格分布预测");
    b4.appendChild(tableDistribution(d.module_4_1m_distribution || []));
    b4.appendChild(el("div",{class:"note"},
      "提示：1个月分布为风险区间估计，并非交易建议。"
    ));
    app.appendChild(c4);

    // ⑤ 未来6个月价格分布预测
    const {c: c5, b: b5} = card("⑤ 未来6个月价格分布预测");
    b5.appendChild(tableDistribution(d.module_5_6m_distribution || []));
    b5.appendChild(el("div",{class:"note"},
      "提示：6个月分布区间更宽，反映更长周期的不确定性累积。"
    ));
    app.appendChild(c5);

    // ⑥ 模型状态与学习更新
    const m6 = d.module_6_model_state || {};
    const {c: c6, b: b6} = card("⑥ 模型状态与学习更新");
    const rows6 = [
      ["模型版本", safeText(m6.model_version || "—")],
      ["标的", safeText(m6.symbol || d.symbol || "—")],
      ["更新时间（北京时间）", fmtDateTime(m6.updated_at_bjt || "—")],
      ["1个月波动率（EWMA，年化）", fmtNum(m6.sigma_ewma_1m_ann, 4)],
      ["基础漂移 μ（日）", fmtNum(m6.mu_daily, 6)],
      ["回报样本数", fmtNum(m6.return_samples, 0)]
    ];
    b6.appendChild(tableKV(rows6));
    b6.appendChild(el("div",{class:"note"},
      "说明：该模块仅展示模型关键状态；具体内部自学习与调参轨迹以系统日志为准。"
    ));
    app.appendChild(c6);

    // ⑦ 过去五个交易日预测命中回顾
    const m7 = d.module_7_last5_hit || [];
    const {c: c7, b: b7} = card("⑦ 过去五个交易日预测命中回顾");
    if(m7.length){
      // 用“字段/当前值”风格做成5条分段（保持截图风格统一，不做复杂表格）
      const box = el("div",{});
      m7.slice(0,5).forEach((it, idx)=>{
        const block = el("div",{style:"border-top:1px solid var(--line);"});
        if(idx===0) block.style.borderTop="none";
        const rows = [
          ["预测对应交易日", safeText(it.y_pred_trade_date)],
          ["实际交易日", safeText(it.today_trade_date)],
          ["预测中位价（P50）", fmtNum(it.y_pred_p50, 3)],
          ["实际收盘价", fmtNum(it.today_close, 2)],
          ["误差（实际-预测）", fmtNum(it.error, 3)],
          ["命中分位区间", safeText(it.hit_band)],
          ["判断结果", safeText(it.judgment)],
          ["生成时间（北京时间）", fmtDateTime(it.generated_at_bjt)]
        ];
        block.appendChild(tableKV(rows));
        box.appendChild(block);
      });
      b7.appendChild(box);
    }else{
      b7.appendChild(el("div",{class:"note"},"暂无 module_7_last5_hit 数据。"));
    }
    app.appendChild(c7);

    // 顶部状态补充
    const reason = d.report_reason ? ("运行说明：" + safeText(d.report_reason)) : "";
    setStatusBoxOK(reason ? reason : "读取成功。");
  }

  async function load(manual){
    try{
      statusText.textContent = "加载中…";
      // 防缓存：加时间戳；同时 cache:no-store
      const u = REPORT_URL + (REPORT_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(u, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const rawText = await res.text();
      const d = JSON.parse(rawText);

      setTopMeta(d);
      await renderAll(d, rawText);

      statusText.textContent = safeText(d.status || "SUCCESS");
      if(manual) toast("已刷新为最新数据");
    }catch(e){
      setStatusBoxError(e && e.message ? e.message : e);
      statusText.textContent = "失败";
      symbolText.textContent = "—";
      tradeDateText.textContent = "—";
      genTimeText.textContent = "—";
      app.innerHTML = "";
      const {c, b} = card("提示");
      b.appendChild(el("div",{class:"note"},
        "当前无法读取 latest_report.json。请确认：\n" +
        "1）仓库根目录存在 latest_report.json；\n" +
        "2）GitHub Pages 已部署到 main / (root)；\n" +
        "3）浏览器打开的是 Pages 地址而非 GitHub 源码地址。"
      ));
      app.appendChild(c);
    }
  }

  // 打开即最新：首次加载 + 每 60 秒自动刷新一次（不打扰样式）
  load(false);
  setInterval(()=>load(false), 60000);
})();
</script>
</body>
</html>

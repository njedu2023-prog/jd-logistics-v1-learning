<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京东物流 V1.0 法定预测报告</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111;
      --muted:#667085;
      --line:#e6e8eb;
      --shadow:0 1px 2px rgba(0,0,0,.04);

      /* 字号：标题 14 / 内容 12 */
      --fs-title:14px;
      --fs-body:12px;

      --ok-bg:#ecfdf3;
      --ok-tx:#0a6a2b;
      --fail-bg:#fff1f0;
      --fail-tx:#b42318;
      --tag-bg:#f0f2f5;
      --tag-tx:#444;
    }

    *{box-sizing:border-box}

    body{
      margin:18px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:1.6;
    }

    .wrap{max-width:1480px;margin:0 auto}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:18px;
      margin:14px 0;
      box-shadow:var(--shadow);
    }

    /* 顶部主标题：14px */
    h1{
      font-size:var(--fs-title);
      margin:0 0 8px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.45;
    }

    /* 模块标题：14px */
    h2{
      font-size:var(--fs-title);
      margin:0 0 10px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .meta{
      color:var(--muted);
      font-size:var(--fs-body);
      font-weight:600;
    }

    .small{
      font-size:var(--fs-body);
      color:var(--muted);
      line-height:1.6;
      font-weight:500;
    }

    .bad{
      background:#fff5f5;
      border-color:#ffd6d6;
    }
    .bad .meta{color:var(--fail-tx)}

    .rowTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .rowTopLeft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tag{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:var(--tag-bg);
      font-size:var(--fs-body);
      color:var(--tag-tx);
      font-weight:800;
      line-height:1.7;
      border:1px solid var(--line);
    }
    .ok{background:var(--ok-bg); color:var(--ok-tx); border-color:#b7ebc6}
    .fail{background:var(--fail-bg); color:var(--fail-tx); border-color:#fda29b}

    .pill{
      display:inline-block;
      padding:2px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:var(--fs-body);
      color:#344054;
      background:#fff;
      font-weight:800;
      line-height:1.7;
    }

    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New";
      font-size:var(--fs-body);
    }
    .mono-wrap{word-break:break-all;white-space:normal}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
    }

    thead th{
      text-align:left;
      font-weight:900;
      padding:10px 10px;
      border-bottom:2px solid var(--line);
      font-size:var(--fs-title); /* 表头=标题 14 */
      background:#fafafa;
      white-space:nowrap;
    }

    tbody td{
      border-bottom:1px solid #eee;
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
      font-weight:600;
      font-size:var(--fs-body);
    }

    .k{
      color:var(--muted);
      width:240px;
      white-space:nowrap;
      font-weight:800;
    }

    .scrollX{overflow:auto}

    /* 仅让“安全边界”这一行左侧标题垂直居中 */
    #safeBoundaryRow td:first-child{ vertical-align: middle; }

    /* ③ 次日分布：值靠左对齐 */
    #m3c th, #m3c td { text-align:left !important; }

    .divider{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card" id="top">
    <div class="rowTop">
      <div class="rowTopLeft">
        <h1 style="margin:0;">京东物流 V1.0 法定预测报告</h1>
        <span class="tag" id="statusTag">加载中</span>
        <span class="pill" id="pill_fetch">DATA: --</span>
        <span class="pill" id="pill_parse">PARSE: --</span>
        <span class="pill" id="pill_render">RENDER: --</span>
      </div>
      <div class="small" id="last_update">Last update: --</div>
    </div>

    <div class="divider"></div>

    <div class="meta" id="metaLine">正在读取 runs/latest_report.json ...</div>
    <div class="small" id="hint"></div>
  </div>

  <div class="card"><h2>① 当日实际交易数据</h2><div id="m1c"></div></div>

  <div class="card"><h2>③ 次日价格分布预测</h2><div id="m3c"></div></div>
  <div class="card"><h2>④ 未来 1 个月价格分布预测</h2><div id="m4c"></div></div>
  <div class="card"><h2>⑤ 未来 6 个月价格分布预测</h2><div id="m5c"></div></div>

  <div class="card"><h2>② 昨日预测回顾</h2><div id="m2c"></div></div>

  <div class="card"><h2>⑥ 模型状态与学习更新</h2><div id="m6c"></div></div>

  <!-- ✅ 模块⑦：按“截图2”的表头与数据结构渲染 -->
  <div class="card"><h2>⑦ 过去五个交易日预测命中回顾</h2><div id="m7c"></div></div>

  <div class="card">
    <div class="small">
      <b>合规声明：</b><br>
      本报告严格遵循“真实数据优先”与“不得回填 / 估算”原则生成。<br>
      若当日真实交易数据不可得，系统将输出完整法定界面结构，并明确标注为占位状态，不进行任何形式的数据推断或补全。
    </div>
  </div>

</div>

<script>
/* =========================================================
 *  1) 配置区（你后续最常改的地方）
 * ========================================================= */
const CONFIG = {
  // 主数据（法定报告）
  REPORT_URL: 'runs/latest_report.json',
  // 兜底行情（简版）
  FALLBACK_URL: 'jd-logistics-latest.json',
  // 自动刷新间隔（毫秒）
  AUTO_REFRESH_MS: 60000,
  // 默认股票代码（当 fallback 里也没有时使用）
  DEFAULT_SYMBOL: '02618.HK'
};

/* =========================================================
 *  2) DOM 简化
 * ========================================================= */
const $ = (id) => document.getElementById(id);

const UI = {
  topCard: () => $('top'),
  statusTag: () => $('statusTag'),
  hint: () => $('hint'),
  metaLine: () => $('metaLine'),
  lastUpdate: () => $('last_update'),
  pillFetch: () => $('pill_fetch'),
  pillParse: () => $('pill_parse'),
  pillRender: () => $('pill_render'),
  m1: () => $('m1c'),
  m2: () => $('m2c'),
  m3: () => $('m3c'),
  m4: () => $('m4c'),
  m5: () => $('m5c'),
  m6: () => $('m6c'),
  m7: () => $('m7c')
};

/* =========================================================
 *  3) 字段中文映射（找不到就回退原字段名）
 *  你新增 JSON 字段时，优先在这里补一条翻译
 * ========================================================= */
const FIELD_ZH = {
  // 顶部/模块①
  trade_date: '交易日期',
  open: '开盘价',
  high: '最高价',
  low: '最低价',
  close: '收盘价',
  volume: '成交量',
  amount_yi_hkd: '成交额（亿港元）',
  amount: '成交额',
  source: '数据来源',
  source_url: '数据源地址',
  fetched_at_bjt: '抓取时间（北京时间）',
  raw_sha1: '数据校验指纹',

  // 分布表
  p: '分位点（P）',
  v: '价格（HKD）',

  // 模块②（保留兼容）
  pred_date: '预测日期',
  pred_close: '预测收盘价',
  reason: '说明',
  note: '备注',

  // ⑥ 关键字段
  sigma_1m: '1个月波动率（EWMA，年化）',
  sigma_6m: '6个月波动率（EWMA，年化）',
  t_nu: '收益分布厚尾参数（t分布ν）',

  // 模块⑥：其它字段翻译
  model_version: '模型版本',
  symbol: '股票代码',
  created_at_bjt: '创建时间（北京时间）',
  updated_at_bjt: '更新时间（北京时间）',
  last_trade_date: '最近交易日',
  last_success_trade_date: '最近成功交易日',
  last_run_id: '最近运行ID',
  run_id: '运行ID',
  last_close: '最近收盘价',

  mu_base: '基础漂移μ',
  sigma_base: '基础波动σ',
  sigma_short: '短期波动σ',
  sigma_mid: '中期波动σ',
  sigma_long: '长期波动σ',

  enable_volume_factor: '是否启用成交量因子',
  enable_beta_anchor: '是否启用β锚定',
  beta_window: 'β计算窗口（天）',
  volume_window: '量能计算窗口（天）',

  safety_limits: '安全边界',
  limits: '安全边界',

  // ⑥ 安全边界展开字段（常见）
  mu_min: 'μ 下限',
  mu_max: 'μ 上限',
  sigma_short_min: '短期σ下限',
  sigma_short_max: '短期σ上限',
  sigma_mid_min: '中期σ下限',
  sigma_mid_max: '中期σ上限',
  sigma_long_min: '长期σ下限',
  sigma_long_max: '长期σ上限',
  jump_prob_min: '跳跃概率下限',
  jump_prob_max: '跳跃概率上限',
  jump_mu_min: '跳跃均值下限',
  jump_mu_max: '跳跃均值上限',
  jump_sigma_min: '跳跃σ下限',
  jump_sigma_max: '跳跃σ上限',

  // 模块⑦（保留原字段翻译）
  eval_date: '评估日期',
  target_trade_date: '目标交易日',
  actual_close: '实际收盘价',
  pred_ref_date: '预测参考日',
  pred_median_t1: '预测中位价',
  pred_p25_t1: '预测 25 分位',
  pred_p75_t1: '预测 75 分位',
  abs_error: '绝对误差',
  rel_error_pct: '相对误差（%）',
  hit_bucket: '命中分位区间',
  judge: '判断结果',
  remark: '备注',
  volume_percentile_20d: '近20日成交量分位'
};

function label(key){ return FIELD_ZH[key] || key; }

/* =========================================================
 *  4) 工具函数区（尽量无业务含义，方便复用）
 * ========================================================= */

/** HTML 转义：防止 JSON 文本插入页面导致 XSS 或结构错乱 */
function escapeHtml(input){
  return String(input)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

function isFiniteNumber(x){
  return typeof x === 'number' && Number.isFinite(x);
}

/** 数字格式化：去掉尾随 0（用于显示更干净） */
function fmtFixedTrim(x, digits){
  if(!isFiniteNumber(x)) return (x == null ? '' : String(x));
  return x.toFixed(digits).replace(/0+$/,'').replace(/\.$/,'');
}

/** 按字段名做更符合业务的显示格式 */
function fmtValueByKey(v, k){
  if(!isFiniteNumber(v)) return String(v);

  // 成交量通常显示整数 + 千分位
  if(k === 'volume') return Math.round(v).toLocaleString('zh-CN');

  // 分位点 p 保留 2 位
  if(k === 'p') return fmtFixedTrim(v, 2);

  // 相对误差百分比保留 2 位
  const lk = String(k).toLowerCase();
  if(lk.includes('rel_error') && lk.includes('pct')) return fmtFixedTrim(v, 2);

  // 默认 2 位
  return fmtFixedTrim(v, 2);
}

/** 尝试把字符串解析为 JSON 对象（用于 safety_limits / limits 可能是字符串的情况） */
function tryParseJsonObject(str){
  if(typeof str !== 'string') return null;
  const s = str.trim();
  if(!(s.startsWith('{') && s.endsWith('}'))) return null;
  try{
    const obj = JSON.parse(s);
    return (obj && typeof obj === 'object' && !Array.isArray(obj)) ? obj : null;
  }catch(_e){
    return null;
  }
}

/** 交易日判断：这里只按“周六/周日”判断（轻量版），不引入港股节假日表 */
function isNonTradingDayBJT(dateStr){
  let dt;
  if(dateStr && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
    // 强制按 +08:00 解析为北京时间零点
    dt = new Date(dateStr + 'T00:00:00+08:00');
  }else{
    // 未给日期时：以当前北京时间判断
    const now = new Date();
    const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
    dt = new Date(utcMs + 8 * 3600000);
  }
  const day = dt.getDay();
  return (day === 0 || day === 6);
}

/** 顶部状态胶囊（pill）写入：用于 DATA/PARSE/RENDER 三个状态 */
function markPill(el, ok, text){
  if(!el) return;
  el.textContent = text;
  el.style.borderColor = ok ? "#b7ebc6" : "#fda29b";
  el.style.color = ok ? "#027a48" : "#b42318";
}

/** 常用占位 HTML */
function smallEmpty(text='暂无数据'){
  return `<div class="small">${escapeHtml(text)}</div>`;
}

/* =========================================================
 *  5) 表格渲染：KV 表 & 数组表
 * ========================================================= */

/**
 * renderScalar：把任意值渲染成表格单元格 HTML
 * - boolean / "true|false" -> 是/否
 * - safety_limits / limits -> 展开成 KV 表
 * - run_id / last_run_id -> 等宽字体+可换行
 * - 数字 -> fmtValueByKey
 */
function renderScalar(v, k){
  if(v == null) return '';

  // 布尔值：显示“是/否”
  if(typeof v === 'boolean'){
    return `<span class="num">${v ? '是' : '否'}</span>`;
  }
  if(typeof v === 'string'){
    const s = v.trim().toLowerCase();
    if(s === 'true' || s === 'false'){
      return `<span class="num">${s === 'true' ? '是' : '否'}</span>`;
    }
  }

  // 安全边界：对象/可解析 JSON 字符串 -> 展开
  if((k === 'safety_limits' || k === 'limits')){
    if(typeof v === 'string'){
      const parsed = tryParseJsonObject(v);
      if(parsed) return `<div class="scrollX">${kvTable(parsed)}</div>`;
    }
    if(typeof v === 'object' && !Array.isArray(v)){
      return `<div class="scrollX">${kvTable(v)}</div>`;
    }
  }

  // 运行ID：等宽 + 自动换行
  if(k === 'run_id' || k === 'last_run_id'){
    return v ? `<span class="mono mono-wrap">${escapeHtml(String(v))}</span>` : '';
  }

  // 普通值
  const s = isFiniteNumber(v) ? fmtValueByKey(v, k) : String(v);
  return `<span class="num">${escapeHtml(s)}</span>`;
}

/**
 * kvTable：把对象渲染成两列表格（字段/当前值）
 * options:
 * - excludeKeys: 不展示的 key
 * - preferredOrder: 优先展示的 key 顺序（其余按原顺序跟在后面）
 */
function kvTable(obj, emptyHint, options={}){
  if(!obj || Object.keys(obj).length === 0) return smallEmpty(emptyHint || '暂无可用数据');

  const exclude = new Set(options.excludeKeys || []);
  const allKeys = Object.keys(obj).filter(k => !exclude.has(k));

  // preferredOrder 提前
  let keys = allKeys;
  const preferred = (options.preferredOrder || []).filter(k => allKeys.includes(k));
  if(preferred.length){
    const rest = allKeys.filter(k => !preferred.includes(k));
    keys = [...preferred, ...rest];
  }

  const rows = keys.map((k) => {
    const v = obj[k];
    const isSafeRow = (label(k) === '安全边界');
    return `<tr ${isSafeRow ? 'id="safeBoundaryRow"' : ''}>
      <td class="k">${escapeHtml(label(k))}</td>
      <td>${renderScalar(v, k)}</td>
    </tr>`;
  }).join('');

  return `
    <table>
      <thead><tr><th>字段</th><th>当前值</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/**
 * arrayTable：把数组对象渲染成表格（用于分布预测等）
 * - 自动汇总所有 key 作为列
 * - 支持 preferredOrder / excludeKeys
 */
function arrayTable(arr, options={}){
  if(!Array.isArray(arr) || arr.length === 0) return smallEmpty('暂无数据');

  const exclude = new Set(options.excludeKeys || []);
  const allKeys = Array.from(new Set(arr.flatMap(x => Object.keys(x || {}))))
    .filter(k => !exclude.has(k));

  let keys = allKeys;
  const preferred = (options.preferredOrder || []).filter(k => allKeys.includes(k));
  if(preferred.length){
    const rest = allKeys.filter(k => !preferred.includes(k));
    keys = [...preferred, ...rest];
  }

  const head = keys.map(k => `<th>${escapeHtml(label(k))}</th>`).join('');
  const body = arr.map(row => {
    const tds = keys.map(k => `<td>${renderScalar(row?.[k], k)}</td>`).join('');
    return `<tr>${tds}</tr>`;
  }).join('');

  return `<div class="scrollX"><table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
}

/* =========================================================
 *  6) 业务适配：fallback 报告结构（合规占位）
 * ========================================================= */
function buildFallbackReport(market){
  const symbol = market?.symbol || market?.ticker || CONFIG.DEFAULT_SYMBOL;
  const trade_date = market?.trade_date || market?.date || '未知';

  // amount（港元） -> amount_yi_hkd（亿港元）
  const amount = isFiniteNumber(market?.amount) ? market.amount : null;
  const amount_yi_hkd = isFiniteNumber(amount) ? (amount / 1e8) : null;

  return {
    status: 'PLACEHOLDER',
    report_reason: '未读取到 runs/latest_report.json，已自动回退到简版行情数据（合规占位，不做预测推断）。',
    symbol,
    trade_date,
    generated_at_bjt: '—',
    module_1_market: {
      symbol,
      trade_date,
      open: market?.open ?? null,
      high: market?.high ?? null,
      low: market?.low ?? null,
      close: market?.close ?? null,
      volume: market?.volume ?? null,
      amount_yi_hkd: amount_yi_hkd ?? null,
      source: 'Fallback JSON',
      source_url: CONFIG.FALLBACK_URL,
      fetched_at_bjt: '—'
    },
    module_2_yesterday_review: {},
    module_3_t1_distribution: [],
    module_4_1m_distribution: [],
    module_5_6m_distribution: [],
    module_6_model_state: {},
    module_7_last5_hit: []
  };
}

/* =========================================================
 *  7) 模块② / 模块⑦：按“截图2结构”渲染（保留你的原逻辑）
 * ========================================================= */

/** 模块②：6 行 KV 结构 */
function renderYesterdayReviewLikeShot2(obj){
  if(!obj || (typeof obj === 'object' && !Array.isArray(obj) && Object.keys(obj).length === 0)){
    return smallEmpty('暂无数据');
  }

  const toNum = (x) => (typeof x === 'number' ? x : (x == null ? null : Number(x)));

  // 兼容多种字段命名（以你的 JSON 为准自动匹配）
  const p50 = toNum(
    obj?.pred_median_p50 ??
    obj?.pred_p50 ??
    obj?.pred_median ??
    obj?.pred_close ??
    obj?.yesterday_pred_p50 ??
    obj?.p50
  );

  const actual = toNum(
    obj?.today_actual_close ??
    obj?.actual_close ??
    obj?.close
  );

  // 误差：优先 obj.error / obj.err / obj.abs_error，否则用 实际-预测
  let err = toNum(obj?.error ?? obj?.err ?? obj?.abs_error);
  if(err == null && p50 != null && actual != null) err = actual - p50;

  const hit = obj?.hit_bucket ?? obj?.hit_band ?? obj?.hit_range ?? obj?.hit_quantile ?? '';
  const judge = obj?.judge ?? obj?.result ?? obj?.judgement ?? obj?.decision ?? '';

  const basePredDate =
    obj?.pred_ref_date ??
    obj?.pred_date ??
    obj?.review_base_pred_date ??
    obj?.base_pred_date ??
    obj?.eval_date ??
    '';

  const rows = [
    ['昨日预测中位价(P50)', fmtFixedTrim(p50, 3)],
    ['今日实际收盘价', fmtFixedTrim(actual, 3)],
    ['误差(实际-预测)', fmtFixedTrim(err, 3)],
    ['命中分位区间', hit],
    ['判断结果', judge],
    ['回顾基于预测日期', basePredDate],
  ].map(([k, v]) => `
    <tr>
      <td class="k">${escapeHtml(k)}</td>
      <td>${escapeHtml(v == null ? '' : String(v))}</td>
    </tr>
  `).join('');

  return `
    <table>
      <thead><tr><th>字段</th><th>数值</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/** 模块⑦：7 列结构 */
function renderHitReviewLikeShot2(arr){
  if(!Array.isArray(arr) || arr.length === 0){
    return smallEmpty('暂无数据');
  }

  const toNum = (x) => (typeof x === 'number' ? x : (x == null ? null : Number(x)));

  const rows = arr.map(r => {
    const predDate   = r?.pred_ref_date ?? r?.eval_date ?? '';
    const actualDate = r?.target_trade_date ?? '';
    const p50        = toNum(r?.pred_median_t1);
    const actual     = toNum(r?.actual_close);

    // 误差：优先 abs_error，否则用 实际-预测P50
    let err = toNum(r?.abs_error);
    if(err == null && p50 != null && actual != null) err = actual - p50;

    const hitBand = r?.hit_bucket ?? r?.hit_band ?? '';
    const judge   = r?.judge ?? '';

    return `<tr>
      <td>${escapeHtml(predDate)}</td>
      <td>${escapeHtml(actualDate)}</td>
      <td>${escapeHtml(fmtFixedTrim(p50, 3))}</td>
      <td>${escapeHtml(fmtFixedTrim(actual, 3))}</td>
      <td>${escapeHtml(fmtFixedTrim(err, 3))}</td>
      <td>${escapeHtml(hitBand)}</td>
      <td>${escapeHtml(judge)}</td>
    </tr>`;
  }).join('');

  return `
    <div class="scrollX">
      <table>
        <thead>
          <tr>
            <th>预测日期</th>
            <th>实际日期</th>
            <th>预测P50</th>
            <th>实际收盘</th>
            <th>误差</th>
            <th>命中区间</th>
            <th>判断</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

/* =========================================================
 *  8) 主渲染：把 report JSON 写入 ①~⑦
 * ========================================================= */
function renderReport(d){
  // 顶部 meta：这里是页面“最重要摘要”
  UI.metaLine().textContent =
    `股票代码：${d.symbol || CONFIG.DEFAULT_SYMBOL} ｜ 交易日期：${d.trade_date || '未知'} ｜ 报告生成时间：${d.generated_at_bjt || '未知'}`;

  // ① 当日实际交易数据（KV 表）
  UI.m1().innerHTML = kvTable(d.module_1_market, '当日无真实交易数据（合规占位）');

  // ③④⑤ 价格分布（数组表）
  UI.m3().innerHTML = arrayTable(d.module_3_t1_distribution);
  UI.m4().innerHTML = arrayTable(d.module_4_1m_distribution);
  UI.m5().innerHTML = arrayTable(d.module_5_6m_distribution);

  // ② 昨日预测回顾（截图2结构：6 行）
  UI.m2().innerHTML = renderYesterdayReviewLikeShot2(d.module_2_yesterday_review);

  // ⑥ 模型状态（KV 表：关键字段排前）
  UI.m6().innerHTML = kvTable(d.module_6_model_state, '暂无数据', {
    preferredOrder: [
      'model_version',
      'created_at_bjt',
      'updated_at_bjt',
      'symbol',
      'last_trade_date',
      'last_success_trade_date',
      'last_close',
      'sigma_1m',
      'sigma_6m',
      't_nu',
      'enable_volume_factor',
      'enable_beta_anchor',
      'beta_window',
      'volume_window',
      'mu_base',
      'sigma_base',
      'sigma_short',
      'sigma_mid',
      'sigma_long',
      'safety_limits',
      'limits',
      'last_run_id',
      'run_id'
    ]
  });

  // ⑦ 过去五日命中回顾（截图2结构：7 列）
  UI.m7().innerHTML = renderHitReviewLikeShot2(d.module_7_last5_hit);
}

/* =========================================================
 *  9) 数据加载：先主报告，失败则 fallback
 * ========================================================= */

/** fetch JSON：加时间戳参数防缓存 */
async function fetchJson(url){
  const u = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
  const r = await fetch(u, { cache: 'no-store' });
  if(!r.ok) throw new Error('HTTP ' + r.status);
  return await r.json();
}

/**
 * 根据 status + 是否交易日，刷新顶部“状态标签/提示语”
 * 你如果未来想加更多状态：在这里改最集中
 */
function applyTopStatus(d){
  const ok = d.status === 'SUCCESS';
  const nonTrading = isNonTradingDayBJT(d.trade_date);

  // 先清理为默认样式
  UI.hint().textContent = '';
  UI.topCard().className = 'card';
  UI.statusTag().className = 'tag';

  if(ok){
    UI.statusTag().textContent = '报告有效';
    UI.statusTag().className = 'tag ok';
    UI.hint().textContent = d.report_reason || '';
    return;
  }

  // 非 SUCCESS：PLACEHOLDER / FAIL / 其它
  UI.topCard().className = 'card bad';

  if(nonTrading){
    UI.statusTag().textContent = '非交易日';
    UI.statusTag().className = 'tag fail';
    UI.hint().textContent =
      '当前为非交易日（港股未开市），系统已自动暂停数据抓取与预测生成；下一个交易日收盘后将自动更新。';
    return;
  }

  UI.statusTag().textContent = (d.status === 'PLACEHOLDER') ? '占位输出' : '数据未就绪';
  UI.statusTag().className = 'tag fail';
  UI.hint().textContent = d.report_reason || '当日数据暂不可用，系统已输出合规占位界面。';
}

/** 当两个数据源都不可用时：输出“合规占位界面” */
function renderAllEmptyByFatal(nonTrading){
  UI.topCard().className = 'card bad';

  if(nonTrading){
    UI.statusTag().textContent = '非交易日';
    UI.statusTag().className = 'tag fail';
    UI.metaLine().textContent = '当前为非交易日（港股未开市），系统已自动暂停运行。';
    UI.hint().textContent = '下一个交易日收盘后将自动生成并更新报告。';
  }else{
    UI.statusTag().textContent = '数据未就绪';
    UI.statusTag().className = 'tag fail';
    UI.metaLine().textContent = '法定界面已输出（数据文件尚未生成/不可访问）';
    UI.hint().textContent = '请检查 runs/latest_report.json 或 jd-logistics-latest.json 是否可访问。';
  }

  UI.m1().innerHTML = smallEmpty();
  UI.m2().innerHTML = smallEmpty();
  UI.m3().innerHTML = smallEmpty();
  UI.m4().innerHTML = smallEmpty();
  UI.m5().innerHTML = smallEmpty();
  UI.m6().innerHTML = smallEmpty();
  UI.m7().innerHTML = smallEmpty();
  UI.lastUpdate().textContent = 'Last update: --';
}

/* =========================================================
 *  10) 主流程：load -> parse -> render
 * ========================================================= */
async function loadAndRender(){
  // 初始状态：正在加载
  markPill(UI.pillFetch(), true, 'DATA: LOADING');
  markPill(UI.pillParse(), true, 'PARSE: --');
  markPill(UI.pillRender(), true, 'RENDER: --');

  try{
    // 1) 先读法定报告
    let data;
    try{
      data = await fetchJson(CONFIG.REPORT_URL);
      markPill(UI.pillFetch(), true, 'DATA: OK');
    }catch(_e1){
      // 2) 法定报告失败 -> 读兜底行情
      const mk = await fetchJson(CONFIG.FALLBACK_URL);
      data = buildFallbackReport(mk);
      markPill(UI.pillFetch(), false, 'DATA: FALLBACK');
      UI.hint().textContent = data.report_reason || '';
      UI.topCard().className = 'card bad';
    }

    // 顶部状态标签（报告有效/非交易日/占位输出/数据未就绪）
    applyTopStatus(data);

    // 解析 & 渲染
    try{
      renderReport(data);
      markPill(UI.pillParse(), true, 'PARSE: OK');
    }catch(e){
      markPill(UI.pillParse(), false, 'PARSE: FAIL');
      UI.hint().textContent = '数据解析失败：' + (e?.message || '未知错误');
      UI.topCard().className = 'card bad';
      return; // 解析失败就不继续写渲染状态
    }

    // 渲染完成
    markPill(UI.pillRender(), true, 'RENDER: OK');
    UI.lastUpdate().textContent = 'Last update: ' + new Date().toISOString();

  }catch(_fatal){
    // 两个都失败：输出合规占位
    markPill(UI.pillFetch(), false, 'DATA: FAIL');
    markPill(UI.pillParse(), false, 'PARSE: --');
    markPill(UI.pillRender(), false, 'RENDER: --');

    const nonTrading = isNonTradingDayBJT(null);
    renderAllEmptyByFatal(nonTrading);
  }
}

/* =========================================================
 *  11) 启动 & 定时刷新
 * ========================================================= */
loadAndRender();
setInterval(loadAndRender, CONFIG.AUTO_REFRESH_MS);
</script>
</body>
</html>
